<!DOCTYPE html>
<!-- 
    WELCOME TO YOUR JUKEBOX CODE! 
    THIS IS THE MAIN FILE THAT CONTROLS EVERYTHING ON THE PAGE.
    
    GUIDE TO EDITING:
    1. TEXT IN GREY (LIKE THIS) ARE COMMENTS. THEY DO NOT AFFECT THE CODE.
    2. LOOK FOR THE SECTIONS IN CAPITAL LETTERS BELOW TO FIND WHAT YOU WANT TO CHANGE.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PFA Jukebox</title>

    <!-- ================================================================================== -->
    <!-- EXTERNAL TOOLS (DO NOT TOUCH THESE LINKS)                                          -->
    <!-- THESE LINES LOAD THE TOOLS WE NEED TO MAKE THE SITE LOOK GOOD AND READ THE CSV FILE -->
    <!-- ================================================================================== -->
    
    <!-- TAILWIND CSS: MAKES STYLING EASIER (COLORS, SPACING, FONTS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONT AWESOME: PROVIDES THE ICONS (LIKE THE MAGNIFYING GLASS AND SPOTIFY LOGO) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PAPAPARSE: THE TOOL THAT READS YOUR 'TRACKS.CSV' FILE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- ================================================================================== -->
    <!-- CUSTOM STYLES (CSS)                                                                -->
    <!-- USE THIS SECTION TO FINE-TUNE SCROLLBARS AND ANIMATIONS                            -->
    <!-- ================================================================================== -->
    <style>
        /* CONTROLS THE SCROLLBAR WIDTH */
        ::-webkit-scrollbar {
            width: 6px;
        }
        /* CONTROLS THE BACKGROUND COLOR OF THE SCROLLBAR TRACK */
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        /* CONTROLS THE COLOR OF THE SCROLLBAR THUMB (THE PART YOU DRAG) */
        /* CURRENTLY SET TO GREEN (#4ade80) */
        ::-webkit-scrollbar-thumb {
            background: #4ade80;
            border-radius: 3px;
        }
        
        /* ANIMATION FOR ROWS FADING IN */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* HELPER TO HIDE SCROLLBARS IN SPECIFIC AREAS TO KEEP IT CLEAN */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<!-- ================================================================================== -->
<!-- MAIN BODY OF THE PAGE                                                              -->
<!-- 'bg-slate-900' IS THE DARK BACKGROUND COLOR.                                       -->
<!-- 'text-slate-200' IS THE DEFAULT TEXT COLOR.                                        -->
<!-- ================================================================================== -->
<body class="bg-slate-900 text-slate-200 font-sans antialiased h-screen flex flex-col overflow-hidden">

    <!-- ================================================================================== -->
    <!-- HEADER SECTION (TOP BAR)                                                           -->
    <!-- CONTAINS THE TITLE AND THE SEARCH BOX                                              -->
    <!-- ================================================================================== -->
    <header class="bg-slate-800 border-b border-slate-700 shadow-md z-20 shrink-0">
        <div class="max-w-3xl mx-auto p-4">
            
            <!-- TITLE BAR & FAVORITES/STATUS BUTTONS (Flex container for main title row) -->
            <div class="flex justify-between items-start w-full mb-4">
                
                <!-- 1. MAIN TITLE TEXT (Aligned left) -->
                <h1 class="text-2xl font-bold text-green-400 tracking-wider flex items-center gap-1 shrink-0">
                    <!-- Musical Note Icons are smaller and tighter -->
                    <i class="fa-solid fa-music text-xl"></i> 
                    PFA JUKEBOX 
                    <i class="fa-solid fa-music text-xl"></i>
                </h1>

                <!-- 2. ACTIONS AND STATUS (Aligned right, stacked vertically) -->
                <div class="flex flex-col items-end gap-1 shrink-0">
                    
                    <!-- NEW FAVORITES/VIEW MODE BUTTON (Slimmed down) -->
                    <button id="view-mode-button" 
                            onclick="switchView()"
                            disabled
                            class="bg-slate-500 text-white font-bold py-1.5 px-3 rounded-full text-xs shadow-md transition duration-150 ease-in-out whitespace-nowrap disabled:opacity-50 disabled:cursor-wait">
                        <i class="fa-solid fa-sync fa-spin mr-2"></i> Loading Data...
                    </button>
                    
                    <!-- LOADING STATUS (Moved below button and styled smaller) -->
                    <div id="status-indicator" class="text-xs flex items-center gap-2">
                        <span id="loading-text" class="text-slate-500 text-[10px]">Initializing...</span>
                    </div>
                </div>
            </div>
            
            <!-- SEARCH BOX SECTION -->
            <div class="relative">
                <!-- MAGNIFYING GLASS ICON -->
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
                </div>
                <!-- THE ACTUAL INPUT FIELD WHERE USERS TYPE -->
                <input type="text" id="search-input" 
                    class="block w-full pl-10 pr-3 py-3 border border-slate-600 rounded-xl leading-5 bg-slate-700 text-slate-100 placeholder-slate-400 focus:outline-none focus:bg-slate-700 focus:border-green-500 focus:ring-2 focus:ring-green-500 sm:text-base transition duration-150 ease-in-out shadow-lg" 
                    placeholder="Search by No, Track or Artist..."
                    disabled>
            </div>
        </div>
    </header>

    <!-- ================================================================================== -->
    <!-- COLUMN HEADERS ROW (NO, TRACK NAME, ARTIST, ACTIONS)                               -->
    <!-- ================================================================================== -->
    <div class="bg-slate-800/80 border-b border-slate-700 text-xs font-semibold text-slate-400 uppercase tracking-wider sticky top-0 z-10 shadow-inner">
        <div class="max-w-3xl mx-auto px-2 py-2 flex items-center gap-2">
            <!-- 'NO.' HEADER -->
            <div class="w-14 text-center shrink-0">No.</div>
            
            <!-- 'TRACK NAME' HEADER -->
            <div class="flex-1 px-2">Track Name</div>
            
            <!-- 'ARTIST' HEADER (HIDDEN ON MOBILE PHONES 'hidden', VISIBLE ON TABLETS/PC 'sm:block') -->
            <div class="hidden sm:block flex-1 px-2">Artist</div>
            
            <!-- ACTIONS HEADER (Adjusted for better visual alignment with the centered heart icons) -->
            <div class="w-10 text-right pr-1 shrink-0">Fav</div>
        </div>
    </div>

    <!-- ================================================================================== -->
    <!-- TRACK LIST CONTAINER                                                               -->
    <!-- ================================================================================== -->
    <main id="track-list" class="flex-1 overflow-y-auto p-2 space-y-3 max-w-3xl mx-auto w-full pb-20">
        <!-- INITIAL LOADING MESSAGE -->
        <div class="text-center py-10 text-slate-500">
            <i class="fa-solid fa-spinner fa-spin text-3xl mb-3 text-green-500"></i>
            <p>Loading tracks and favorites...</p>
        </div>
    </main>

    <!-- ================================================================================== -->
    <!-- JAVASCRIPT LOGIC SECTION (NOW INCLUDES FIREBASE FOR PERSISTENCE)                   -->
    <!-- ================================================================================== -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('Debug'); // Uncomment this line to see detailed Firebase logs

        // --- GLOBAL VARIABLES (FROM ENVIRONMENT) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- APP STATE VARIABLES ---
        let allTracks = []; 
        const trackListElement = document.getElementById('track-list');
        const searchInput = document.getElementById('search-input');
        const viewModeButton = document.getElementById('view-mode-button');
        const loadingTextSpan = document.getElementById('loading-text');

        // Firebase / Firestore setup
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isTracksLoaded = false; // Flag to track when CSV data is ready
        let isFavoritesLoaded = false; // NEW: Flag to track when initial Firestore data is ready
        let favoriteTrackNos = new Set();
        let currentView = 'all'; // 'all' or 'favorites'

        // --- FALLBACK DATA ---
        const fallbackCSV = `No.,Track Name,Artist,Year Released,Album:,Spotify Link:,Youtube Link:
00-01,Heroes,David Bowie,1977,Bowie the singles 1968-1993,https://open.spotify.com/search/Heroes%20David%20Bowie,https://www.youtube.com/results?search_query=Heroes%20David%20Bowie%20music%20video
00-02,Beauty and the Beast,David Bowie,1978,Bowie the singles 1968-1993,https://open.spotify.com/search/Beauty%20and%20the%20Beast%20David%20Bowie,https://www.youtube.com/results?search_query=Beauty%20and%20the%20Beast%20David%20Bowie%20music%20video
60-05,Let Me Put My Love Into You,AC/DC,1980,Back in Black,https://open.spotify.com/search/Let%20Me%20Put%20My%20Love%20Into%20You%20AC/DC,https://www.youtube.com/results?search_query=Let%20Me%20Put%20My%20Love%20Into%20You%20AC/DC%20music%20video
60-06,Back In Black,AC/DC,1980,Back in Black,https://open.spotify.com/search/Back%20In%20Black%20AC/DC,https://www.youtube.com/results?search_query=Back%20In%20Black%20AC/DC%20music%20video
60-07,You Shook Me All Night Long,AC/DC,1980,Back in Black,https://open.spotify.com/search/You%20Shook%20Me%20All%20Night%20Long%20AC/DC,https://www.youtube.com/results?search_query=You%20Shook%20Me%20All%20Night%20Long%20AC/DC%20music%20video`;

        // --- FIREBASE UTILITIES ---
        
        // Defines the Firestore path for the user's favorites list
        function getFavoritesDocRef() {
            // Path: /artifacts/{appId}/users/{userId}/favourites/list
            const path = `/artifacts/${appId}/users/${userId}/favourites`;
            return doc(db, path, 'list');
        }

        // Loads and listens for real-time changes to the favorites list
        function loadFavorites() {
            if (!db || !isAuthReady) return;

            loadingTextSpan.textContent = `User ${userId.substring(0, 8)}... authenticated. Loading favorites.`;
            
            // Use onSnapshot to listen for real-time updates to the favorites document
            onSnapshot(getFavoritesDocRef(), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    // Ensure data.trackNos is an array before setting the Set
                    const trackArray = Array.isArray(data.trackNos) ? data.trackNos : [];
                    favoriteTrackNos = new Set(trackArray);
                } else {
                    // Initialize as an empty set if the document doesn't exist yet
                    favoriteTrackNos = new Set();
                }
                
                isFavoritesLoaded = true; // Mark favorites as loaded
                synchronizeAndRender(); // Attempt to render
                
            }, (error) => {
                console.error("Error loading favorites:", error);
                isFavoritesLoaded = true; // Still mark as loaded (even on error)
                synchronizeAndRender();
            });
        }

        // Saves the current set of favorites to Firestore
        async function saveFavorites() {
            if (!db || !userId) {
                console.warn("Cannot save favorites: DB not ready or User ID missing.");
                return;
            }
            try {
                // Save the Set as an Array
                await setDoc(getFavoritesDocRef(), { trackNos: Array.from(favoriteTrackNos) }, { merge: false });
            } catch (error) {
                console.error("Error saving favorites:", error);
            }
        }
        
        // Initializes Firebase and authenticates the user
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not found. Favorites feature disabled.");
                isAuthReady = true;
                isFavoritesLoaded = true;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Authenticate user using custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up Auth Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Fallback if no user is provided (highly unlikely)
                        userId = crypto.randomUUID(); 
                    }
                    
                    isAuthReady = true;
                    // Start listening for data immediately after authentication is confirmed
                    loadFavorites(); 
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                isAuthReady = true;
                isFavoritesLoaded = true; // Treat as loaded to unblock CSV data
                synchronizeAndRender();
            }
        }

        // --- APP LOGIC ---
        
        // NEW: Checks both flags and triggers the final render when ready
        function synchronizeAndRender() {
            if (isTracksLoaded && isFavoritesLoaded) {
                console.log("Synchronization complete. Rendering full list.");
                
                // Enable UI elements
                viewModeButton.disabled = false;
                searchInput.disabled = false;
                
                // Apply filters and render
                const tracksToRender = filterAndSearchTracks(searchInput.value, allTracks, currentView, favoriteTrackNos);
                renderTracks(tracksToRender);
                updateViewButtonText();
            }
        }
        
        // Toggles a track's favorite status and saves it
        window.toggleFavorite = function(trackNo, event) {
            // Prevent the parent row from expanding/collapsing when clicking the heart
            event.stopPropagation(); 

            if (!isAuthReady) {
                console.warn("Authentication not ready. Cannot toggle favorite.");
                return;
            }

            if (favoriteTrackNos.has(trackNo)) {
                favoriteTrackNos.delete(trackNo);
            } else {
                favoriteTrackNos.add(trackNo);
            }
            
            // Save the updated list to Firestore
            saveFavorites();
            // The UI re-render is now purely handled by the real-time 'onSnapshot' listener.
        };

        // Toggles between viewing All Tracks and Favourites
        window.switchView = function() {
            currentView = (currentView === 'all') ? 'favorites' : 'all';
            
            // Clear search when switching views
            searchInput.value = ''; 
            
            // Re-run search/filter logic and render
            synchronizeAndRender();
        }

        // Updates the text and style of the view toggle button
        function updateViewButtonText() {
            const favCount = favoriteTrackNos.size;
            
            // Update track count status text
            loadingTextSpan.textContent = `${allTracks.length} tracks loaded. ${favCount} favorites saved.`;


            if (currentView === 'all') {
                viewModeButton.innerHTML = `<i class="fa-solid fa-heart mr-2"></i> View Favourites (${favCount})`;
                viewModeButton.classList.remove('bg-yellow-600', 'text-slate-900', 'hover:bg-yellow-700', 'bg-slate-500');
                viewModeButton.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');
            } else {
                viewModeButton.innerHTML = `<i class="fa-solid fa-list-ul mr-2"></i> View All Tracks (${allTracks.length})`;
                viewModeButton.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700', 'bg-slate-500');
                viewModeButton.classList.add('bg-yellow-600', 'text-slate-900', 'hover:bg-yellow-700');
            }
            
            // Ensure spinner is removed
            viewModeButton.querySelector('.fa-spin')?.remove();
        }
        
        // Combines search and view filtering logic
        function filterAndSearchTracks(searchTerm, tracks, view, favSet) {
            let filtered = tracks;
            
            // 1. Filter by Favourites view
            if (view === 'favorites') {
                filtered = filtered.filter(track => favSet.has(track['No.']));
            }

            // 2. Filter by Search term
            if (searchTerm) {
                const lowerSearchTerm = searchTerm.toLowerCase();
                filtered = filtered.filter(track => {
                    const title = (track['Track Name'] || '').toLowerCase();
                    const artist = (track['Artist'] || '').toLowerCase();
                    const num = (track['No.'] || '').toLowerCase();
                    return title.includes(lowerSearchTerm) || 
                           artist.includes(lowerSearchTerm) || 
                           num.includes(lowerSearchTerm);
                });
            }
            return filtered;
        }


        // --- DATA LOADING (CSV) ---
        function useFallbackData() {
            Papa.parse(fallbackCSV, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                }
            });
        }

        function processData(data) {
            // REMOVE EMPTY ROWS
            allTracks = data.filter(row => row['Track Name'] && row['Track Name'].trim() !== '');
            
            // Set the flag that CSV data is ready
            isTracksLoaded = true;
            
            // Attempt to render, checking if favorites are also loaded
            synchronizeAndRender();
        }

        // --- RENDER TRACKS: THIS CREATES THE HTML FOR EACH SONG ---
        function renderTracks(tracks) {
            trackListElement.innerHTML = ''; // CLEAR THE LIST BEFORE DRAWING

            // Display message if no tracks are found
            if (tracks.length === 0) {
                const message = currentView === 'favorites' 
                    ? `Your favorites list is empty. Add tracks by clicking the heart icon!`
                    : `No tracks found matching your search.`;

                trackListElement.innerHTML = `
                    <div class="text-center py-10 text-slate-500">
                        <i class="fa-solid fa-face-sad-tear text-3xl mb-3 text-slate-600"></i>
                        <p>${message}</p>
                    </div>`;
                return;
            }

            // LOOP THROUGH EVERY TRACK AND CREATE THE HTML
            tracks.forEach((track, index) => {
                const uniqueId = `track-${track['No.']}`; // Using No. for stable ID
                
                // --- READ DATA FROM CSV COLUMNS ---
                const num = track['No.'] || 'N/A';
                const title = track['Track Name'] || 'Unknown Title';
                const artist = track['Artist'] || 'Unknown Artist';
                const year = track['Year Released'] || '';
                const album = track['Album:'] || '';
                const spotify = track['Spotify Link:'];
                const youtube = track['Youtube Link:'];

                // Determine if this track is a favorite
                const isFavorite = favoriteTrackNos.has(num);
                const favIconClass = isFavorite 
                    ? 'text-red-500 fa-solid fa-heart' // Filled red heart
                    : 'text-slate-400 fa-regular fa-heart group-hover:text-red-400'; // Outlined heart

                // STYLE FOR THE MAIN ROW CONTAINER
                const row = document.createElement('div');
                row.className = 'bg-slate-800 rounded-xl shadow-lg border border-slate-700 overflow-hidden fade-in hover:border-green-600/50 hover:bg-slate-700/50 transition-all duration-200 group';
                
                // --- THE HTML STRUCTURE FOR A SINGLE ROW ---
                row.innerHTML = `
                    <!-- VISIBLE PART OF THE ROW -->
                    <div class="flex items-center gap-2 p-3 select-none">
                        
                        <!-- TRACK INFO AREA (DEDICATED CLICK TARGET FOR DETAILS) -->
                        <div class="flex items-center flex-1 min-w-0 cursor-pointer" onclick="window.toggleDetails('${uniqueId}')">
                            <!-- TRACK NUMBER (WHITE TEXT) -->
                            <div class="w-14 text-center font-mono font-bold text-white shrink-0 text-sm bg-slate-900/50 py-1 rounded-md shadow-inner">
                                ${num}
                            </div>

                            <!-- TRACK TITLE & ARTIST (MOBILE VIEW) -->
                            <div class="flex-1 px-2 min-w-0 flex flex-col justify-center">
                                <div class="text-slate-100 font-medium truncate text-base">${title}</div>
                                <!-- ARTIST SHOWS HERE ONLY ON MOBILE -->
                                <div class="text-xs text-slate-400 truncate sm:hidden">${artist}</div>
                            </div>

                            <!-- ARTIST COLUMN (DESKTOP VIEW ONLY) -->
                            <div class="hidden sm:block flex-1 px-2 text-slate-400 truncate">
                                ${artist}
                            </div>
                        </div>

                        <!-- ACTIONS: FAVORITE (HEART) - The w-10 container uses 'justify-center' for center alignment. -->
                        <div class="w-10 flex justify-center items-center shrink-0">
                            
                            <!-- 1. FAVORITE BUTTON (HEART) -->
                            <button 
                                id="btn-${uniqueId}" 
                                onclick="window.toggleFavorite('${num}', event)"
                                class="w-8 h-8 rounded-full bg-slate-700/50 hover:bg-slate-700 flex items-center justify-center transition-all duration-200"
                                title="${isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}"
                            >
                                <i class="${favIconClass} text-xl transition-colors"></i>
                            </button>
                        </div>
                    </div>

                    <!-- HIDDEN DETAILS (EXPANDS WHEN CLICKED) -->
                    <div id="${uniqueId}" class="hidden bg-slate-900/90 border-t border-slate-700/50 text-sm">
                        <div class="p-4 grid gap-3">
                            
                            <!-- EXTRA INFO: YEAR AND ALBUM -->
                            <div class="flex flex-wrap gap-4 text-slate-400">
                                ${year ? `<div class="flex items-center gap-2"><i class="fa-regular fa-calendar text-green-500"></i> ${year}</div>` : ''}
                                ${album ? `<div class="flex items-center gap-2"><i class="fa-solid fa-compact-disc text-green-500"></i> ${album}</div>` : ''}
                            </div>

                            <!-- BUTTONS: SPOTIFY AND YOUTUBE -->
                            <div class="flex gap-3 mt-4">
                                <!-- SPOTIFY BUTTON LOGIC -->
                                ${spotify && spotify.trim() !== '' ? `
                                    <a href="${spotify}" target="_blank" class="flex-1 bg-[#1DB954] hover:bg-[#1ed760] text-white py-3 px-4 rounded-lg text-center font-semibold transition flex items-center justify-center gap-2 shadow-xl shadow-green-900/30">
                                        <i class="fa-brands fa-spotify text-xl"></i> Spotify
                                    </a>
                                ` : '<span class="flex-1 bg-slate-700 text-slate-500 py-3 px-4 rounded-lg text-center cursor-not-allowed flex items-center justify-center gap-2">No Spotify Link</span>'}
                                
                                <!-- YOUTUBE BUTTON LOGIC -->
                                ${youtube && youtube.trim() !== '' ? `
                                    <a href="${youtube}" target="_blank" class="flex-1 bg-[#FF0000] hover:bg-[#ff3333] text-white py-3 px-4 rounded-lg text-center font-semibold transition flex items-center justify-center gap-2 shadow-xl shadow-red-900/30">
                                        <i class="fa-brands fa-youtube text-xl"></i> YouTube
                                    </a>
                                ` : '<span class="flex-1 bg-slate-700 text-slate-500 py-3 px-4 rounded-lg text-center cursor-not-allowed flex items-center justify-center gap-2">No YouTube Link</span>'}
                            </div>
                        </div>
                    </div>
                `;
                
                trackListElement.appendChild(row);
            });
        }

        // --- CLICK HANDLER: OPENS AND CLOSES THE ROW ---
        window.toggleDetails = function(id) {
            const detailsPanel = document.getElementById(id);
            
            if (detailsPanel.classList.contains('hidden')) {
                // OPEN THE ROW
                detailsPanel.classList.remove('hidden');
            } else {
                // CLOSE THE ROW
                detailsPanel.classList.add('hidden');
            }
        };

        // --- SEARCH HANDLER: LISTENS FOR TYPING ---
        searchInput.addEventListener('input', (e) => {
            if (!isTracksLoaded) return; // Prevent search on incomplete data
            synchronizeAndRender();
        });

        // START THE APP
        function init() {
            // 1. Start Firebase initialization (async)
            initializeFirebase();
            
            // 2. Load CSV data (async)
            try {
                Papa.parse('tracks.csv', {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        loadingTextSpan.textContent = `CSV Loaded. Waiting for favorites...`;
                        processData(results.data);
                    },
                    error: function(err) {
                        console.warn("Could not load tracks.csv. Using fallback data.");
                        useFallbackData();
                    }
                });
            } catch (error) {
                console.warn("Caught synchronous error loading CSV. Using fallback data.");
                useFallbackData();
            }
        }
        init();

    </script>
</body>
</html>
